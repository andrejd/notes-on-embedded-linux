## U-Boot, the Universal Bootloader

U-Boot takes place in the embedded Linux system as a third stage bootloader. It is responsible of configuring main interfaces and launching a Linux system. Note however that it is possible to avoid this step and to directly boot Linux from AT91Bootstrap, in a production phase for instance.

>Latest versions of U-Boot supports loading Device Tree Binary (DTB), which describes the hardware in a binary file, and compressed kernel image, zImage, a compressed version of the Linux kernel image that is self-extracting.

U-Boot natively supports loading kernel as uImage, an image file that has a U-Boot wrapper that includes the OS type and loader information. uImage is created by the mkimage utility that comes in source code with U-Boot distribution and it is built during U-Boot compilation (u-boot-source-dir/tools/mkimage).

A very common practice (e.g. the typical Linux kernel Makefile) is to use a zImage file. Since a zImage file is self-extracting, therefore needs no external decompressors.

#### U-Boot environment

The U-Boot environment is a little read/write persistent space that stores variables needed by the bootloader to configure itself properly and to adapt to its environment (network configuration, boot arguments, storage location, etc.). It is located in the same media that it has booted from.

> U-Boot will try to read environment variables from NAND and in case there are none, it will use default values defined at compile time.

> U-Boot environment is flashed at the same time as Linux kernel and DTB and it is generated by SAM_BA flashing script on the fly to account for kernel and DTB image size. See chapter on SAM-BA scripts for example.


#### Basic U-Boot usage

U-Boot can be used among other things also to supply Linux kernel with custom command line which can be helpful to change kernel behavior without recompilation.

Some useful U-Boot commands:

- `printenv`: displays current environment variables, you can see cmd line that will be passed to kernel
- `setenv`: sets new env variables; not stored in flash and they will be lost upon reboot, you can save them with `saveenv` command
- `saveenv`: save environment variables to persistent storage
- `editenv`: edit existing variable
- `bootdelay`: time before loading kernel
- ...


### Build U-Boot for AcmeSystems Acqua SoM

Get source code for U-Boot from official [GitHub repository](https://github.com/u-boot/u-boot). Once there, download `.zip` version of specific tag, e.g. `2015.04` or clone whole repository to your computer and checkout specific tag.

U-Boot source tree has to be patched for Acqua SoM. Patch will add needed `_defconfig` files and support for reading MAC address and SERIAL NUMBER from on board eeprom. Patch file can be downloaded from [Final patch to support Acqua on u-boot](https://groups.google.com/forum/#!topic/acmesystems/tYwnNBkogJ0) thread on AcmeSystems Google Groups group.

```bash
# first unzip downloaded archive
unzip u-boot-2015.04.zip

# go into newly created directory
cd u-boot-2015.04

# download patch file for AcmeSystems Acqua SoM
wget https://groups.google.com/group/acmesystems/attach/ac9d4bdf3c4ff053/final_support_acqua_on_uboot.patch

# patch U-Boot source tree
patch -p1 <  final_support_acqua_on_uboot.patch

# load initial configuration (created by patch in configs/ directory)
make acqua_nandflash_defconfig

# change settings, e.g. enable network support
make menuconfig

# save current configuration to defconfig file (optional, see make help for more information)
# defconfig file can be copied to /configs directory for later use
make savedefconfig

# compile u-boot sources, image u-boot.bin will be created in the root of source tree
make CROSS_COMPILE=arm-linux-gnueabi-
```

Configuration for loading kernel from NAND flash, with added network support
```java
CONFIG_ARM=y
CONFIG_ARCH_AT91=y
CONFIG_TARGET_ACME_ACQUA=y
CONFIG_SYS_EXTRA_OPTIONS="SAMA5D3,SYS_USE_NANDFLASH"
CONFIG_NET=y
```

### U-Boot customization

To customize U-Boot, e.g to change autoboot text, enable watchdog, set password to enter into U-Boot console etc., you need to define additional macros in board file, e.g. `acqua.h` for Acmesystems Acqua board in `include/configs` folder, see the [documentation](https://github.com/u-boot/u-boot/blob/master/doc/README.autoboot):
```
#define CONFIG_RESET_TO_RETRY
#define CONFIG_BOOT_RETRY_TIME 60 // this option does not work if using keyed option below

#define CONFIG_AUTOBOOT_KEYED
#define CONFIG_AUTOBOOT_STOP_STR "<your password>"
#define CONFIG_AUTOBOOT_PROMPT "\nType password to cancel autoboot, you have %d seconds:\n", bootdelay
```

### Flashing linux images with U-Boot

You can use U-Boot to flash network images of e.g. new kernel and fs to onboard flash memory. To do that, U-Boot has to be configured with `CONFIG_NET=y` option and network environmental variables has to ve set. Here is part of actual U-Boot environment where all needed variables are set (`ipaddr`, `netmask`, `serverip`). Then you need running tftp server on address defined with `ipaddr`. `upadateXY` are helper variables which can be executed by `run updateXY`. You can execute `run updatefs` to download new file system image from server and flash it on the board.

```bash
ipaddr=192.168.1.96
netmask=255.255.255.0
serverip=192.168.1.28
update=tftpboot 0x22000000 ${filename} && nand erase.spread clean ${nandaddr} 0xF800000 && nand write.trimffs ${fileaddr} ${nandaddr} ${filesize}
update1=tftpboot 0x22000000 ${filename} && nand erase ${nandaddr} ${erasesize} && nand write ${fileaddr} ${nandaddr} ${filesize}
update2=tftpboot 0x21000000 ${filename} && nand erase ${nandaddr} ${erasesize} && nand write ${fileaddr} ${nandaddr} ${filesize}
updatedt=nandaddr=0x00180000 && erasesize=0x80000 && filename=acme-acqua.dtb && run update2
updatefs=nandaddr=0x00800000 && erasesize=0x600000 && filename=rootfs.ubi && run update
updatekrnl=nandaddr=0x00200000 && erasesize=0x600000 && filename=zImage && run update1
```
